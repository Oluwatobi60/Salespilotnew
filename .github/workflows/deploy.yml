name: Deploy to VPS

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        port: 22
        script_stop: true
        script: |
          echo "üöÄ DEPLOYMENT STARTED"
          echo "===================="
          
          cd /opt/salespital
          
          echo "1. Backup..."
          if [ -f "backup_enhanced.sh" ]; then
            ./backup_enhanced.sh
          else
            echo "Quick backup..."
            BACKUP_DIR="/backup"
            mkdir -p $BACKUP_DIR
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            docker exec salespilot-mysql mysqldump -u root -pOluwaTobi60 --all-databases > $BACKUP_DIR/backup_$TIMESTAMP.sql 2>/dev/null && \
            gzip $BACKUP_DIR/backup_$TIMESTAMP.sql || echo "Backup failed, continuing..."
          fi
          
          echo ""
          echo "2. Update code..."
          git stash 2>/dev/null || true
          git clean -fd
          git fetch origin
          git reset --hard origin/master
          
          echo ""
          echo "3. Deploy containers..."
          
          # Method 1: Try docker-compose restart first (gentle)
          echo "Trying gentle restart..."
          docker-compose restart 2>/dev/null || true
          
          sleep 10
          
          # Check if gentle restart worked
          if curl -s -f --max-time 10 http://localhost:8787 > /dev/null 2>&1; then
            echo "‚úÖ Gentle restart successful"
          else
            echo "Gentle restart failed, trying full restart..."
            
            # Method 2: Stop and start without removing network
            docker-compose stop 2>/dev/null || true
            docker-compose up -d --build 2>/dev/null || {
              echo "‚ùå Docker-compose failed";
              echo "Trying direct docker commands...";
              
              # Method 3: Direct docker commands as fallback
              docker stop salespilot-nginx salespilot-app salespilot-mysql 2>/dev/null || true
              docker rm salespilot-nginx salespilot-app salespilot-mysql 2>/dev/null || true
              
              cd /opt/salespilot
              docker-compose up -d --build
            }
          fi
          
          echo ""
          echo "4. Verify..."
          sleep 15
          
          echo "Container status:"
          docker-compose ps 2>/dev/null || docker ps | grep salespilot
          
          echo ""
          echo "Application check:"
          if curl -s -f --max-time 10 http://localhost:8787 > /dev/null; then
            echo "‚úÖ Application is running"
            echo ""
            echo "üéâ DEPLOYMENT SUCCESSFUL"
            echo "Version: $(git log --oneline -1)"
          else
            echo "‚ùå Application check failed"
            echo "Showing logs..."
            docker-compose logs --tail=30 2>/dev/null || echo "Cannot get logs"
            exit 1
          fi
          
    - name: Verify Remote
      run: |
        echo "üåê Final verification..."
        sleep 25
        
        for i in {1..3}; do
          echo "Check $i/3..."
          if curl -s -f --max-time 30 http://${{ secrets.VPS_HOST }}:8787 > /dev/null; then
            echo "‚úÖ SUCCESS: Application deployed"
            echo "URL: http://${{ secrets.VPS_HOST }}:8787"
            exit 0
          else
            echo "Check $i failed, waiting..."
            sleep 10
          fi
        done
        
        echo "‚ùå Application not accessible"
        echo "Deployment may have partial issues"
        exit 1
