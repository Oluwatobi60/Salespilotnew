name: Deploy to VPS

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy with Backup
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "üöÄ Automated Deployment Process"
            echo "================================"
            
            cd /opt/salespilot
            
            # Step 1: Backup
            echo "üì¶ Step 1: Creating backup..."
            if [ -f "backup_enhanced.sh" ]; then
                ./backup_enhanced.sh
            elif [ -f "backup.sh" ]; then
                ./backup.sh
            else
                echo "‚ö†Ô∏è  Creating basic backup..."
                BACKUP_DIR="/backup"
                mkdir -p $BACKUP_DIR
                TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                docker exec salespilot-mysql mysqldump -u root -pOluwaTobi60 --all-databases > $BACKUP_DIR/mysql_backup_$TIMESTAMP.sql && \
                gzip $BACKUP_DIR/mysql_backup_$TIMESTAMP.sql && \
                echo "‚úÖ Basic backup created"
            fi
            
            # Step 2: Pull code
            echo "üì• Step 2: Pulling latest code..."
            git pull origin master
            
            # Step 3: Deploy
            echo "üõë Step 3: Stopping old containers..."
            docker-compose down
            
            echo "üöÄ Step 4: Starting new containers..."
            docker-compose up -d --build
            
            # Step 4: Verify
            echo "‚è≥ Step 5: Waiting for startup..."
            sleep 40
            
            echo "üìä Step 6: Verifying deployment..."
            echo ""
            echo "üê≥ Container Status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo ""
            echo "‚úÖ Deployment process completed!"
            
            # Show status
            if [ -f "status.sh" ]; then
                echo ""
                ./status.sh
            fi
            
      - name: Verify Application
        run: |
          echo "üåê Verifying application access..."
          MAX_RETRIES=6
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES to connect..."
            if curl -s -f --max-time 30 http://${{ secrets.VPS_HOST }}:8787 > /dev/null; then
              echo "‚úÖ SUCCESS: Application is accessible at http://${{ secrets.VPS_HOST }}:8787"
              echo ""
              echo "üìã Deployment Summary:"
              echo "‚Ä¢ ‚úÖ Backup created before deployment"
              echo "‚Ä¢ ‚úÖ Code updated from GitHub"
              echo "‚Ä¢ ‚úÖ Docker containers restarted"
              echo "‚Ä¢ ‚úÖ Application verified as accessible"
              exit 0
            else
              echo "Attempt $i failed, retrying in $RETRY_DELAY seconds..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "‚ùå Application verification failed after $MAX_RETRIES attempts"
          echo "Checking error logs..."
          
          # Get error logs via SSH
          ssh -o StrictHostKeyChecking=no \
              -i <(echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}") \
              "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
              "cd /opt/salespilot && docker-compose logs --tail=100"
          exit 1
