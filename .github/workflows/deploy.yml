name: Deploy to VPS

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        port: 22
        script_stop: true
        script: |
          set -e  # Exit on any error
          
          echo "üöÄ STARTING DEPLOYMENT"
          echo "======================"
          
          cd /opt/salespilot
          
          # Use the deploy script if it exists
          if [ -f "deploy.sh" ]; then
            ./deploy.sh
          else
            echo "‚ö†Ô∏è  Using fallback deployment..."
            
            # Backup
            BACKUP_DIR="/backup"
            mkdir -p $BACKUP_DIR
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            docker exec salespilot-mysql mysqldump -u root -pOluwaTobi60 --all-databases > $BACKUP_DIR/backup_$TIMESTAMP.sql
            gzip $BACKUP_DIR/backup_$TIMESTAMP.sql
            
            # Pull code
            git stash
            git clean -fd
            git fetch origin
            git reset --hard origin/master
            
            # Deploy
            docker-compose down --remove-orphans
            docker-compose up -d --build
            
            # Verify
            sleep 20
            if curl -s -f http://localhost:8787 > /dev/null; then
              echo "‚úÖ Deployment successful"
            else
              echo "‚ùå Deployment failed"
              exit 1
            fi
          fi
          
          echo ""
          echo "üéâ DEPLOYMENT COMPLETE"
          echo "Version deployed: $(git log --oneline -1)"
          
    - name: Verify Remote Access
      run: |
        echo "üåê Verifying application is publicly accessible..."
        sleep 25
        
        for i in {1..5}; do
          echo "Attempt $i/5..."
          if curl -s -f --max-time 30 http://${{ secrets.VPS_HOST }}:8787 > /dev/null; then
            echo "‚úÖ SUCCESS: Application is live at http://${{ secrets.VPS_HOST }}:8787"
            echo ""
            echo "üìã Deployment Summary:"
            echo "‚Ä¢ Code: $(curl -s http://${{ secrets.VPS_HOST }}:8787 | grep -o 'Version:.*' | head -1 || echo 'Version info not found')"
            echo "‚Ä¢ Status: Running"
            echo "‚Ä¢ Port: 8787"
            exit 0
          else
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          fi
        done
        
        echo "‚ùå Application not accessible after deployment"
        exit 1
