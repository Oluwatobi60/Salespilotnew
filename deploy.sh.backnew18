#!/bin/bash
echo "ðŸš€ Salespilot Deployment Script"
echo "================================"

set -e  # Exit on error

cd /opt/salespilot || { echo "âŒ Cannot cd to /opt/salespilot"; exit 1; }

echo "1. Checking container status..."
docker-compose ps

echo ""
echo "2. Creating backup..."
if [ -f "backup_enhanced.sh" ]; then
    ./backup_enhanced.sh
else
    echo "Using quick backup..."
    BACKUP_DIR="/backup"
    mkdir -p $BACKUP_DIR
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    if docker ps | grep -q "salespilot-mysql"; then
        docker exec salespilot-mysql mysqldump -u root -pOluwaTobi60 --all-databases > $BACKUP_DIR/deploy_$TIMESTAMP.sql 2>/dev/null
        gzip $BACKUP_DIR/deploy_$TIMESTAMP.sql 2>/dev/null || echo "Backup compression failed"
    else
        echo "MySQL container not found, skipping database backup"
    fi
fi

echo ""
echo "3. Pulling latest code..."
git fetch origin
git pull origin master

echo ""
echo "4. Deploying containers..."
echo "Stopping any running salespilot containers..."
docker-compose stop 2>/dev/null || echo "No containers to stop"

echo "Starting all containers..."
docker-compose up -d --build

echo ""
echo "5. Waiting for startup..."
echo "Waiting for containers to become healthy..."
for i in {1..30}; do
    echo -n "."
    
    # Check if all containers are running
    RUNNING_COUNT=$(docker-compose ps --services | wc -l)
    UP_COUNT=$(docker-compose ps --services | xargs -I{} sh -c 'docker-compose ps {} | grep -q "Up" && echo 1' | wc -l)
    
    if [ "$RUNNING_COUNT" -eq "$UP_COUNT" ] && [ "$UP_COUNT" -gt 0 ]; then
        echo ""
        echo "âœ… All containers are running"
        break
    fi
    
    if [ $i -eq 30 ]; then
        echo ""
        echo "âš ï¸  Containers taking too long to start"
    fi
    
    sleep 2
done

echo ""
echo "6. Verifying deployment..."
echo "Container status:"
docker-compose ps

echo ""
echo "Application check:"
# Wait a bit more for app to be ready
sleep 10

if curl -s -f --max-time 10 http://localhost:8787 > /dev/null; then
    echo "âœ… Application is running on port 8787"
    echo ""
    echo "âœ… Deployment completed successfully!"
    echo "Version: $(git log --oneline -1)"
else
    echo "âŒ Application check failed"
    echo "Checking individual containers..."
    
    echo ""
    echo "Nginx logs (last 5 lines):"
    docker-compose logs --tail=5 nginx 2>/dev/null || echo "Cannot get nginx logs"
    
    echo ""
    echo "App logs (last 5 lines):"
    docker-compose logs --tail=5 app 2>/dev/null || echo "Cannot get app logs"
    
    echo ""
    echo "MySQL logs (last 5 lines):"
    docker-compose logs --tail=5 mysql 2>/dev/null || echo "Cannot get mysql logs"
    
    exit 1
fi
